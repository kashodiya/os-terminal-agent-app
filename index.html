<!DOCTYPE html>
<html>
<head>
    <title>OS Terminal Agent App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.6.0/dist/vuetify.min.css" rel="stylesheet">
    <style>
        .message-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            padding: 8px 0;
        }
        .command-output {
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 12px;
            border-radius: 4px;
            margin: 8px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div id="app">
        <v-app>
            <v-app-bar app color="primary" dark>
                <v-toolbar-title>OS Terminal Agent App</v-toolbar-title>
                <v-spacer></v-spacer>
                <v-btn text @click="$router.push('/')">Home</v-btn>
                <v-btn text @click="$router.push('/about')">About</v-btn>
            </v-app-bar>
            <v-main>
                <router-view></router-view>
            </v-main>
        </v-app>
    </div>

    <div id="home-template" style="display: none;">
        <v-container fluid fill-height>
            <v-row no-gutters style="height: 100%;">
                <v-col>
                    <v-card height="calc(100vh - 120px)" class="d-flex flex-column">
                        <v-card-title>OS Terminal Agent Chat</v-card-title>
                        <v-card-text class="flex-grow-1 overflow-y-auto" ref="chatContainer">
                            <div v-for="(message, index) in messages" :key="index" class="mb-3">
                                <v-chip small :color="message.type === 'user' ? 'primary' : 'secondary'" class="mb-1">
                                    {{ message.type === 'user' ? 'You' : 'Agent' }}
                                </v-chip>
                                <div class="message-content" v-html="renderContent(message.content)"></div>
                            </div>
                            <div v-if="isTyping" class="mb-3">
                                <v-chip small color="secondary" class="mb-1">Agent</v-chip>
                                <div class="message-content" v-html="renderContent(currentResponse)"></div>
                            </div>
                        </v-card-text>
                        <v-card-actions>
                            <v-text-field
                                v-model="userInput"
                                label="Ask the agent..."
                                @keyup.enter="sendMessage"
                                :disabled="isTyping"
                                outlined
                                dense
                                class="flex-grow-1 mr-2"
                            ></v-text-field>
                            <v-btn @click="sendMessage" :disabled="!userInput.trim() || isTyping" color="primary">
                                <v-icon>mdi-send</v-icon>
                            </v-btn>
                        </v-card-actions>
                    </v-card>
                </v-col>
            </v-row>
        </v-container>
    </div>

    <div id="about-template" style="display: none;">
        <v-container fluid>
            <v-row>
                <v-col>
                    <h1>About</h1>
                    <p>This is the OS Terminal Agent Application.</p>
                </v-col>
            </v-row>
        </v-container>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.6.0/dist/vuetify.js"></script>
    <script src="https://unpkg.com/vue-router@3/dist/vue-router.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        const Home = {
            template: '#home-template',
            data() {
                return {
                    messages: [],
                    userInput: '',
                    isTyping: false,
                    currentResponse: '',
                    ws: null
                };
            },
            mounted() {
                this.connectWebSocket();
            },
            beforeDestroy() {
                if (this.ws) {
                    this.ws.close();
                }
            },
            methods: {
                connectWebSocket() {
                    this.ws = new WebSocket('ws://localhost:8000/ws');
                    
                    this.ws.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        
                        if (data.type === 'chunk') {
                            this.currentResponse += data.content;
                        } else if (data.type === 'command_output') {
                            this.currentResponse += '\n\nðŸ“¤ Command Output:\n';
                            this.currentResponse += '<pre class="command-output">' + this.escapeHtml(data.content) + '</pre>';
                        } else if (data.type === 'complete') {
                            this.messages.push({
                                type: 'agent',
                                content: this.currentResponse
                            });
                            this.currentResponse = '';
                            this.isTyping = false;
                            this.$nextTick(() => this.scrollToBottom());
                        }
                    };
                    
                    this.ws.onerror = () => {
                        console.error('WebSocket error');
                    };
                },
                sendMessage() {
                    if (!this.userInput.trim() || this.isTyping) return;
                    
                    this.messages.push({
                        type: 'user',
                        content: this.userInput
                    });
                    
                    this.ws.send(JSON.stringify({
                        message: this.userInput
                    }));
                    
                    this.userInput = '';
                    this.isTyping = true;
                    this.currentResponse = '';
                    this.$nextTick(() => this.scrollToBottom());
                },
                scrollToBottom() {
                    const container = this.$refs.chatContainer;
                    if (container) {
                        container.scrollTop = container.scrollHeight;
                    }
                },
                escapeHtml(text) {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                },
                renderContent(content) {
                    if (!content) return '';
                    // Check if content contains markdown patterns
                    if (content.includes('**') || content.includes('##') || content.includes('```') || content.includes('- ')) {
                        return marked.parse(content);
                    }
                    return content;
                }
            }
        };
        const About = { template: '#about-template' };

        const routes = [
            { path: '/', component: Home },
            { path: '/about', component: About }
        ];

        const router = new VueRouter({ routes });

        new Vue({
            el: '#app',
            router,
            vuetify: new Vuetify()
        });
    </script>
</body>
</html>